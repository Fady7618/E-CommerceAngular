<section class="product-details spad" *ngIf="product; else loadingTemplate">
  <div class="row">
    <div class="col-lg-6">
      <div class="product__details__pic h-100">
        <div class="product__details__pic__left product__thumb">
          <a class="pt" [class.active]="activeImageIndex === i" (click)="changeImage(i, image.name)"
            *ngFor="let image of product?.gallery; let i = index">
            <img src="{{ image.name }}" alt="Product Image">
          </a>
        </div>
        <div class="product__details__slider__content h-100">
          <div class="img h-100">
            <img class="" src="{{ main_image }}" alt="Product Image">
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="product__details__text">
        <h3>{{ product?.detail?.name || product?.name || 'Product' }}</h3>
        <div class="rating">
          <i class="fa fa-star me-1"></i>
          <i class="fa fa-star me-1"></i>
          <i class="fa fa-star me-1"></i>
          <i class="fa fa-star me-1"></i>
          <i class="fa fa-star me-1"></i>
          <span>( {{ product?.rating?.count || 138 }} reviews )</span> | <span style="color: rgb(33, 210, 107);"> In Stock</span>
        </div>
        <!-- Updated price section with safe navigation -->
        <div class="product__details__price">
          ${{ (product?.price_after || 0).toFixed(2) }} 
          <span>${{ (product?.price || 0).toFixed(2) }}</span>
        </div>
        <p>{{ product?.detail?.desc || product?.description || 'No description available' }}</p>
        <hr>
        <div class="product-options">
          <div class="color-selection d-flex" style="gap: 20px;">
            <h5>Colours :</h5>
            <div class="d-flex" style="gap: 10px;">
              <div *ngFor="let color of colors; let i = index">
                <input type="radio" name="color" [id]="'color-' + i" [value]="color.value">
                <label [for]="'color-' + i" class="color-input" [style.background-color]="color.value" [title]="color.name"></label>
              </div>
            </div>
          </div>
          <div class="size-selection d-flex" style="gap: 20px;">
            <h5>Size :</h5>
            <div class="d-flex" style="gap: 10px;">
              <button *ngFor="let size of sizes" 
                      class="size-button" 
                      [class.selected]="selectedSize === size"
                      (click)="selectSize(size)">
                {{ size }}
              </button>
            </div>
          </div>
        </div>
        <div class="d-flex" style="gap: 20px; align-items: center;">
          <div class="quantity d-flex">
            <button (click)="decreaseQuantity()">-</button>
            <input type="number" id="quantity" [(ngModel)]="quantity" min="1" readonly>
            <button (click)="increaseQuantity()">+</button>
          </div>
          <button class="cart-btn" (click)="addToCart()">Buy Now</button>
          <button class="size-button m-0 ms-3" style="padding: 10px;">
            <i class="fa-regular fa-heart"></i>
          </button>
        </div>
        <div class="delivery-info">
          <div class="delivery-option">
            <div class="icon">
              <i class="fa-solid fa-truck-fast"></i>
            </div>
            <div class="text">
              <h5>Free Delivery</h5>
              <p>Enter your postal code for Delivery Availability</p>
            </div>
          </div>
          <div class="delivery-option">
            <div class="icon">
              <i class="fa-solid fa-arrows-rotate"></i>
            </div>
            <div class="text">
              <h5>Return Delivery</h5>
              <p>Free 30 Days Delivery Returns.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Related Products Section -->
<section *ngIf="related && related.length > 0">
  <div class="mt-5 mb-5 d-flex">
    <div class="related rounded"></div>
    <h3 class="text-danger ms-4">Related Item</h3>
  </div>
  <div class="row">
    <div class="col-lg-3 mb-3" *ngFor="let item of related">
      <div class="card h-100">
        <div class="add-card position-relative">
          <div class="img">
            <img src="{{ item.image }}" class="card-img-top position-relative border-bottom bg-body-secondary" alt="Product Image">
          </div>
          <div>
            <i class="fa-regular fa-heart position-absolute top-0 end-0 mt-2 me-2 bg-white p-2 rounded-circle"></i>
            <i class="fa-regular fa-eye position-absolute top-0 end-0 mt-5 me-2 bg-white p-2 rounded-circle"></i>
          </div>
          <button class="border-0 bg-dark text-white text-center p-3 position-absolute w-100 add-to-cart">
            Add To Cart
          </button>
        </div>
        <div class="card-body bg-white" style="z-index: 1;">
          <a routerLink="/product/single/{{ item.id }}">
            <p class="card-title">{{ item.name || item.title }}</p>
          </a>
          <div>
            <span class="text-danger me-2">${{ (item.price_after || 0).toFixed(2) }}</span>
            <span class="text-light-emphasis text-decoration-line-through">${{ (item.price || 0).toFixed(2) }}</span>
          </div>
          <div class="stars">
            <i class="fa-solid fa-star text-warning"></i>
            <i class="fa-solid fa-star text-warning"></i>
            <i class="fa-solid fa-star text-warning"></i>
            <i class="fa-solid fa-star text-warning"></i>
            <i class="fa-solid fa-star text-warning"></i>
            <span class="text-light-emphasis ms-1">({{ item.rating?.count || 88 }})</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="text-center py-5" style="min-height: 50vh; display: flex; align-items: center; justify-content: center;">
    <div>
      <div class="spinner-border text-danger mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted">Loading product details...</p>
    </div>
  </div>
</ng-template>
